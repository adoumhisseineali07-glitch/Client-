<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEBTY-PRO INTERNATIONAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="manifest" href="manifest.json">
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>

    <style>
        :root { --primary: #0d47a1; --secondary: #2196f3; --success: #00c853; --danger: #d32f2f; --bg: #f5f7fa; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; }
        .login-box input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 18px; text-align: center; }

        .header { background: var(--primary); color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 10px; }
        .container { padding: 15px; }
        .search-bar { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; }

        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); margin-bottom: 12px; border-left: 5px solid var(--secondary); position: relative; }
        .card.paid { border-left-color: var(--success); opacity: 0.7; }
        .card.expense { border-left-color: var(--danger); } /* Style pour les d√©penses */
        
        .row { display: flex; justify-content: space-between; align-items: center; }
        .amount { color: var(--danger); font-weight: bold; font-size: 1.1em; }
        .amount.plus { color: var(--success); }

        .actions { display: flex; gap: 8px; margin-top: 12px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; }
        .btn-wa { background: #25D366; }
        .btn-pay { background: var(--primary); }
        .btn-edit { background: #f39c12; flex: 0.3; }

        .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 500; }
        .fab { width: 60px; height: 60px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); border: none; }
        .fab.add-dette { background: var(--secondary); }
        .fab.add-depense { background: var(--danger); font-size: 18px; width: 50px; height: 50px; align-self: flex-end; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; width: 85%; border-radius: 15px; }
        .modal-content input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

        .tabs { display: flex; margin-bottom: 15px; background: #ddd; padding: 4px; border-radius: 10px; }
        .tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 8px; }
        .tab.active { background: white; color: var(--primary); font-weight: bold; }
    </style>
</head>

<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary)">D√âBTY-PRO üîê</h2>
            <p id="log-desc" style="font-size: 0.9em; color: #666; margin-bottom: 10px;">Entrez votre code PIN</p>
            <input type="password" id="log-p" placeholder="Code PIN">
            <button onclick="checkLogin()" id="btn-login-main" style="background: var(--secondary); width: 100%; padding: 15px; border-radius: 10px; border:none; color:white; font-weight:bold; cursor:pointer;">OUVRIR LA SESSION</button>
        </div>
    </div>

    <div id="app" style="display:none">
        <div class="header">
            <strong>SUIVI DES CR√âDITS & D√âPENSES</strong>
            <div class="stats-grid">
                <div class="stat-box">
                    <div id="t-dette" style="font-size: 1.1em; font-weight: bold;">0 F</div> <small>Dettes</small>
                </div>
                <div class="stat-box">
                    <div id="t-depense" style="font-size: 1.1em; font-weight: bold;">0 F</div> <small>D√©penses</small>
                </div>
            </div>
            <button onclick="exportData()" style="background:none; color:white; font-size:0.7em; margin-top:10px; text-decoration:underline; border:none; cursor:pointer">Sauvegarder (.txt)</button>
        </div>

        <div class="container">
            <input type="text" id="search" class="search-bar" placeholder="üîç Rechercher client ou article..." onkeyup="render()">

            <div class="tabs">
                <div class="tab active" id="tab-en_cours" onclick="switchTab('en_cours')">Dettes Actives</div>
                <div class="tab" id="tab-dep" onclick="switchTab('dep')">D√©penses</div>
                <div class="tab" id="tab-histo" onclick="switchTab('histo')">Archives</div>
            </div>

            <div id="list"></div>
        </div>

        <div class="fab-container">
            <button class="fab add-depense" onclick="showAddDepense()" title="Ajouter D√©pense">OUT</button>
            <button class="fab add-dette" onclick="showAdd()">+</button>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Nouveau Cr√©dit</h3>
            <input type="hidden" id="edit-id"> 
            <input type="text" id="f-nom" placeholder="Nom du Client">
            <input type="number" id="f-tel" placeholder="N¬∞ WhatsApp (sans indicatif)">
            <input type="number" id="f-mnt" placeholder="Montant">
            <input type="text" id="f-mot" placeholder="Article(s) achet√©(s)">
            <div class="actions">
                <button onclick="closeModal()" style="background:#999">Annuler</button>
                <button onclick="saveDette()" style="background:var(--success)">ENREGISTRER</button>
            </div>
        </div>
    </div>

    <div id="modal-depense" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--danger)">Nouvelle D√©pense</h3>
            <input type="text" id="d-mot" placeholder="Motif (ex: Loyer, Transport)">
            <input type="number" id="d-mnt" placeholder="Montant (F)">
            <div class="actions">
                <button onclick="closeModal()" style="background:#999">Annuler</button>
                <button onclick="saveDepense()" style="background:var(--danger)">ENREGISTRER</button>
            </div>
        </div>
    </div>

    <script>
        let savedPIN = localStorage.getItem('debty_pin_pro');
        let db = JSON.parse(localStorage.getItem('debty_v2_cam')) || [];
        let depenses = JSON.parse(localStorage.getItem('debty_depenses')) || [];
        let tab = 'en_cours';

        window.onload = function () {
            if (!savedPIN) {
                document.querySelector('#login-screen h2').innerText = "BIENVENUE";
                document.querySelector('#log-desc').innerText = "Veuillez cr√©er votre code PIN (4 chiffres)";
                document.getElementById('btn-login-main').innerText = "CR√âER MON CODE";
            }
        }

        function checkLogin() {
            const pInput = document.getElementById('log-p').value;
            if (!savedPIN) {
                if (pInput.length >= 4) {
                    localStorage.setItem('debty_pin_pro', pInput);
                    savedPIN = pInput;
                    alert("‚úÖ Code PIN cr√©√© !");
                    entrerDansApp();
                } else { alert("Minimum 4 chiffres"); }
            } else {
                if (pInput === savedPIN) { entrerDansApp(); } 
                else { alert("‚õî CODE PIN INCORRECT !"); }
            }
        }

        function entrerDansApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            render();
        }

        function switchTab(t) {
            tab = t;
            document.getElementById('tab-en_cours').classList.toggle('active', t === 'en_cours');
            document.getElementById('tab-dep').classList.toggle('active', t === 'dep');
            document.getElementById('tab-histo').classList.toggle('active', t === 'histo');
            render();
        }

        function showAdd() {
            document.getElementById('modal-title').innerText = "Nouveau Cr√©dit";
            document.getElementById('edit-id').value = "";
            document.getElementById('f-nom').value = ""; document.getElementById('f-tel').value = "";
            document.getElementById('f-mnt').value = ""; document.getElementById('f-mot').value = "";
            document.getElementById('modal').style.display = 'flex';
        }

        function showAddDepense() {
            document.getElementById('d-mot').value = "";
            document.getElementById('d-mnt').value = "";
            document.getElementById('modal-depense').style.display = 'flex';
        }

        function saveDette() {
            const id = document.getElementById('edit-id').value;
            const data = {
                id: id ? parseInt(id) : Date.now(),
                nom: document.getElementById('f-nom').value,
                tel: document.getElementById('f-tel').value,
                mnt: parseInt(document.getElementById('f-mnt').value),
                mot: document.getElementById('f-mot').value,
                date: new Date().toLocaleDateString(),
                paye: false
            };
            if (!data.nom || !data.mnt) return alert("Nom et montant requis");
            if (id) {
                const index = db.findIndex(d => d.id === parseInt(id));
                db[index] = { ...db[index], ...data };
            } else { db.unshift(data); }
            localStorage.setItem('debty_v2_cam', JSON.stringify(db));
            closeModal(); render();
        }

        function saveDepense() {
            const motif = document.getElementById('d-mot').value;
            const montant = document.getElementById('d-mnt').value;
            if(!motif || !montant) return alert("Remplissez tous les champs");
            depenses.unshift({ id: Date.now(), motif, mnt: parseInt(montant), date: new Date().toLocaleDateString() });
            localStorage.setItem('debty_depenses', JSON.stringify(depenses));
            closeModal(); render();
        }

        function editDette(id) {
            const d = db.find(x => x.id === id);
            document.getElementById('modal-title').innerText = "Modifier Cr√©dit";
            document.getElementById('edit-id').value = d.id;
            document.getElementById('f-nom').value = d.nom;
            document.getElementById('f-tel').value = d.tel;
            document.getElementById('f-mnt').value = d.mnt;
            document.getElementById('f-mot').value = d.mot;
            document.getElementById('modal').style.display = 'flex';
        }

        function encaisser(id) {
            if (confirm("Marquer comme pay√© ?")) {
                let d = db.find(x => x.id === id);
                d.paye = true; d.datePaye = new Date().toLocaleDateString();
                localStorage.setItem('debty_v2_cam', JSON.stringify(db));
                render();
            }
        }

        function supprimerDepense(id) {
            if(confirm("Supprimer cette d√©pense ?")) {
                depenses = depenses.filter(x => x.id !== id);
                localStorage.setItem('debty_depenses', JSON.stringify(depenses));
                render();
            }
        }

        function rappel(nom, tel, mnt, mot) {
            if (!tel) return alert("Pas de num√©ro WhatsApp.");
            let indicatif = "237";
            let n = tel.startsWith(indicatif) ? tel : indicatif + tel;
            const m = `Bonjour *${nom}*, rappel de votre dette de *${mnt} F* pour : *${mot}*. Merci.`;
            window.open(`https://wa.me/${n}?text=${encodeURIComponent(m)}`);
        }

        function exportData() {
            const data = { dettes: db, depenses: depenses };
            const blob = new Blob([JSON.stringify(data)], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `SAUVEGARDE_DEBTY_${new Date().toLocaleDateString()}.txt`;
            a.click();
        }

        function closeModal() { 
            document.getElementById('modal').style.display = 'none'; 
            document.getElementById('modal-depense').style.display = 'none';
        }

        function render() {
            const list = document.getElementById('list');
            const search = document.getElementById('search').value.toLowerCase();
            list.innerHTML = "";

            let sDette = 0, sDepense = 0;
            db.forEach(x => { if (!x.paye) sDette += x.mnt; });
            depenses.forEach(x => { sDepense += x.mnt; });

            document.getElementById('t-dette').innerText = sDette.toLocaleString() + " F";
            document.getElementById('t-depense').innerText = sDepense.toLocaleString() + " F";

            if (tab === 'dep') {
                const filteredDep = depenses.filter(x => x.motif.toLowerCase().includes(search));
                filteredDep.forEach(x => {
                    list.innerHTML += `<div class="card expense">
                        <div class="row"><div><strong>${x.motif}</strong><br><small>${x.date}</small></div><div class="amount">${x.mnt.toLocaleString()} F</div></div>
                        <div class="actions"><button onclick="supprimerDepense(${x.id})" style="background:gray; font-size:0.8em">Supprimer</button></div>
                    </div>`;
                });
            } else {
                const filtered = db.filter(x => (tab === 'en_cours' ? !x.paye : x.paye) && (x.nom.toLowerCase().includes(search) || x.mot.toLowerCase().includes(search)));
                filtered.forEach(x => {
                    list.innerHTML += `<div class="card ${x.paye ? 'paid' : ''}">
                        <div class="row"><div><strong>${x.nom}</strong><br><small>${x.mot} (${x.date})</small></div><div class="amount">${x.mnt.toLocaleString()} F</div></div>
                        ${!x.paye ? `<div class="actions"><button class="btn-edit" onclick="editDette(${x.id})">‚úèÔ∏è</button><button class="btn-wa" onclick="rappel('${x.nom}','${x.tel}',${x.mnt},'${x.mot}')">WhatsApp</button><button class="btn-pay" onclick="encaisser(${x.id})">R√©gl√©</button></div>` : `<div style="text-align:right; color:green; font-size:0.8em; margin-top:5px">Pay√© le ${x.datePaye}</div>`}
                    </div>`;
                });
            }
        }
    </script>
</body>
</html>
